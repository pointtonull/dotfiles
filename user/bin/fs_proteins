#!/usr/bin/env python3

import os
import webbrowser

from fatsecret import Fatsecret
from datetime import datetime, timedelta

DAY = timedelta(days=1)

CONSUMER_KEY = os.env["FS_CONSUMER_KEY"]
CONSUMER_SECRET = os.environ["FS_CONSUMER_SECRET"]


class MyFatSecret:

    def __init__():
        session_token = get_session_token()

    def get_session(self):
        session_token = open("~/.fatsecret_session_token").strip().split()
        fatsecret = Fatsecret(CONSUMER_KEY, SECRET_KEY, session_token)
        # fatsecret = Fatsecret(CONSUMER_KEY, CONSUMER_SECRET)
        # auth_url = fatsecret.get_authorize_url()
        # webbrowser.open(auth_url)
        # pin = input("Pin: ")
        # fatsecret.authenticate("896q79te")
        return session

    def get_month(self):
        last_mont = []
        today = datetime.today()

        for days_ago in reversed(range(1, 30)):
            date = today - days_ago * day
            print(date)
            eaten = fatsecret.food_entries_get(date=date)
            last_mont.append(eaten)
        return last_mont

    def get_score(food):
        return food["protein"] ** 2 / food["calories"]

    def get_protein_ri(self):
        ## PROTEIN
        profile = fatsecret.profile_get()
        weight_kg = profile["last_weight_kg"]
        # 92.5
        protein_per_day_per_kg = 0.56
        # 0.56
            total_daily_protein = protein_per_day_per_kg * weight_kg
            # 51.800000000000004
            total_weekly_protein = total_daily_protein * 7
            # 362.6
            total_monthly_protein = total_daily_protein * 30
            fatsecret = get_session()
            month = get_month(fatsecret)

    def check(self):
        # men should not eat more than 30g of saturated fat a day
        # women should not eat more than 20g of saturated fat a day
        # adults should not have more than about 5g of trans fats a day
        # optimize unsaturated fats / total fats

        totals = defaultdict(lambda: defaultdict(float))
        for entry in month:
            for food in entry:
                food_id = food["food_id"]
                food_name = food["food_entry_name"]
                calories = float(food["calories"])
                protein = float(food["protein"])
                total = totals[food_id]
                total["id"] = food_id
                total["name"] = food_name
                total["calories"] += calories
                total["protein"] += protein

        score_name = []
        for food in totals.values():
            score_name.append((get_score(food), food["name"]))
        score_name.sort(reverse=True)

        score_name[:20]

        total = sum(food["protein"] for food in totals.values())


def main():
    my_fat_secret = MyFatSecret()
    my_fat_secret.print_warnings()
    my_fat_secret.print_recommendations()

if __name__ == "__main__":
    main()
