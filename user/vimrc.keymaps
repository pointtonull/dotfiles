set nocompatible

let mapleader = ","

map Å‚ ~

" enter intoduces new line without leaving normal mode
"nmap <CR> o

nnoremap <M-j> :m .+1<CR>==
nnoremap <M-k> :m .-2<CR>==
inoremap <M-j> <Esc>:m .+1<CR>==gi
inoremap <M-k> <Esc>:m .-2<CR>==gi
vnoremap <M-j> :m '>+1<CR>gv=gv
vnoremap <M-k> :m '<-2<CR>gv=gv

vnoremap <space> ;
vnoremap <backspace> ,
nnoremap <space> ;
nnoremap <backspace> ,
vnoremap <right> ;
vnoremap <left> ,
nnoremap <right> ;
nnoremap <left> ,


" Executes and/or retrieves current line in shell
nmap <leader>ES <leader>esdd
nmap <leader>ec :.w !bc -l<CR>
nmap <leader>es :exec "!".expand(getline("."))<CR>
nmap <leader>rc yyp:.!bc -l<CR>
nmap <leader>rs :exec "r!".expand(getline("."))<CR>


" Config edition keybinds
nmap <leader>vk :tabnew ~/.vimrc.keymaps<CR>
nmap <leader>vc :tabnew ~/.vimrc.common<CR>
if has('nvim')
    nmap <leader>ve :tabnew ~/.config/nvim/init.vim<CR>
    nmap <leader>vr :source ~/.config/nvim/init.vim<CR>:redraw<CR>
else
    nmap <leader>ve :tabnew ~/.vimrc<CR>
    nmap <leader>vr :source ~/.vimrc<CR>:redraw<CR>
endif

vnoremap <leader>u S<ul>

nnoremap gf <C-W>gf

nmap <leader>aj :!column -t<CR>
vmap <leader>aj :!column -t<CR>
nmap <leader>ac :center<CR>
vmap <leader>ac :center<CR>
nmap <leader>ah :left<CR>
vmap <leader>ah :left<CR>
nmap <leader>al :right<CR>
vmap <leader>al :right<CR>
nmap <leader><Space>  :%s/Â¬/ /g<CR>

vmap <leader>S :sort!<CR>
vmap <leader>s :sort<CR>

" Quick search commands
nmap <leader>/e /\<error\\|\w\+error\>\\|\<exception\\|\<traceback<CR>GN
nmap <leader>/n /.*NotImplementedError*<CR>
nmap <leader>// :noh<CR>
nmap <leader>/( /\%80c<CR>
nmap <leader>/) /\%90c<CR>
nmap <leader>/= /\%100c<CR>
nmap <leader>/8 /\%80c<CR>
nmap <leader>/9 /\%90c<CR>
nmap <leader>/0 /\%100c<CR>

nmap <leader>sh :%s/<\/\?div>/\r/ge \| %s/^ *\([0-9]+\.\|-\)*//e \| %s/<br>/\r/ge \| %s/&nbsp;//ge \| %g!/./de \| noh<CR>
"nmap <leader>sl :%s/^[0-9,: \-]\+ /<CR>:%g/^\tat\|Ignoring/d<CR>:%s/\v^(\w+ +)\[[A-z 0-9-]{-}\]/\1 <CR>:%s/^[0-9]\{5,}	\+//<CR>:%s/\(s3:\/\/\)/\r\1<CR>

nnoremap <leader>fa cc!fopen
nnoremap <leader>fe cc!vim
nnoremap <leader>fr cc!vimrenamer -rls
nnoremap <leader>fu cc!vimrenamer -rlsoU
nnoremap <leader>fv cc!vlc
nnoremap == gg=G
nnoremap <leader>f gqq
vnoremap <leader>f gq

vmap <leader>y "+y
nmap <leader>y "+y
nmap <leader>d "+d
vmap <leader>d "+d
nmap <leader>yy V"+y
nmap <leader>dd V"+ydd
vmap <leader>P "+gP
nmap <leader>P "+gP
vmap <leader>p "+gp
nmap <leader>p "+gp

" Para alineacion rapida <leader>aq <leader>ac <leader>ad
nmap <leader>aj :!column -t<CR>
vmap <leader>aj :!column -t<CR>
nmap <leader>ac :center<CR>
vmap <leader>ac :center<CR>
nmap <leader>ah :left<CR>
vmap <leader>ah :left<CR>
nmap <leader>al :right<CR>
vmap <leader>al :right<CR>

nmap <leader>! :python3 comentado("!")<CR>
nmap <leader>" :python3 comentado("\"")<CR>
nmap <leader>$ :python3 comentado("$")<CR>
nmap <leader>% :python3 comentado("%")<CR>
nmap <leader>- :python3 comentado("--")<CR>
nmap <leader>/ :python3 comentado("/*", "*/")<CR>
nmap <leader>< :python3 comentado("<!--", "-->")<CR>
nmap <leader>c :python3 comentado()<CR>
nmap <leader>Â· :python3 comentado("#")<CR>
vmap <leader>! :python3 comentado("!")<CR>
vmap <leader>" :python3 comentado("\"")<CR>
vmap <leader>$ :python3 comentado("$")<CR>
vmap <leader>% :python3 comentado("%")<CR>
vmap <leader>- :python3 comentado("--")<CR>
vmap <leader>/ :python3 comentado("/*", "*/")<CR>
vmap <leader>< :python3 comentado("<!--", "-->")<CR>
vmap <leader>c :python3 comentado()<CR>
vmap <leader>Â· :python3 comentado("#")<CR>

python3 << EOF
import vim

def comentado(inicio=None, final=None):
    """ si ejecutado sin argumentos intenta usar cms"""
    if not inicio:
        try:
            cms = vim.current.buffer.options["cms"].decode() or "%s"
        except:
            cms = vim.current.buffer.options["cms"] or "%s"
        inicio, final = cms.split("%s")
    si = False
    no = False
    rango = vim.current.range
    if not final:
        for indice in range(len(rango)):
            if rango[indice].strip():
                if rango[indice].strip().startswith(str(inicio)):
                    si = True
                else:
                    no = True
        print(si, no, inicio, final)
        if no:
            for indice in range(len(rango)):
                if rango[indice].strip():
                    rango[indice] = str(inicio) + rango[indice]
        elif si and not no:
            for indice in range(len(rango)):
                rango[indice] = rango[indice][rango[indice].find(inicio) + len(inicio):]
    else:
        if (rango[0].strip().startswith(inicio) and
                rango[-1].strip().endswith(final)):
            rango[0] = rango[0][rango[0].index(inicio) + len(inicio):]
            rango[-1] = rango[-1][:rango[-1].rindex(final)]
        else:
            rango[0] = inicio + rango[0]
            rango[-1] = rango[-1] + final

EOF

nmap <leader>g :Git
nmap <leader>gB :Gblame<CR>
nmap <leader>gC :Gcommit<CR>
nmap <leader>gR :Gremove<CRr
nmap <leader>gb :Gbrowse<CR>
nmap <leader>gc :Gcommit -m ""
nmap <leader>gd :Gdiff<CR>
nmap <leader>ge :Gedit<CR>
nmap <leader>gg :Ggrep
nmap <leader>gl :Glog<cr>
nmap <leader>gm :Gmove
nmap <leader>gp :Git push<CR>:redraw!<>
nmap <leader>gr :Gread<CR>
nmap <leader>gs :Gstatus<CR>
nmap <leader>gw :Gwrite<CR>
vmap <leader>gB :Gblame<CR>
vmap <leader>gb :Gbrowse<CR>
vmap <leader>gd :Gdiff<CR>
vmap <leader>gr :Gread<CR>
vmap <leader>i :!gindent -npro -nut -nlp -bli4 -br -nprs -nsc -nss -pi4<CR>

nmap <leader>it :r!date +"\%A \%d \%B \%Y \%H:\%M:\%S"
nmap <leader>iT :-1r!date +"\%A \%d \%B \%Y \%H:\%M:\%S
nmap <leader>id :r!date +"\%A \%d \%B \%Y"
nmap <leader>iD :-1r!date +"\%A \%d \%B \%Y"

nmap <leader>du :diff<CR>
nmap <leader>dr :diff<CR>
nmap <leader>ds ggyG:%s/^<\{7}\_.\{-}=\{7}.*\n//ig<CR>:%s/^>\{7}.*\n//ig<CR>:diffthis<CR>:rightb vnew<CR>PGdd:%s/^=\{7}\_.\{-}>\{7}.*\n//ig<CR>:%s/^<\{7}.*\n//ig<CR>:set filetype=python<CR>:diffthis<CR>
nmap <leader>dh <C-w>hggdGdd<C-w>lggyG<C-w>hP
nmap <leader>dl <C-w>lggdGdd<C-w>hggyG<C-w>lP
nmap <leader>dn ]c
nmap <leader>dN [c
nmap <leader>dj :diffget<CR>
nmap <leader>dk :diffput<CR>

nmap <M-Right> <C-W>w
nmap <M-Left> <C-W>W
imap <C-H> <C-D>
imap <C-L> <C-T>
imap <leader>h <C-D>
imap <leader>l <C-T>
nmap <leader>h <<
nmap <leader>l >>
vmap <leader>h <
vmap <leader>l >

nmap <leader>w :w<CR>
nmap <leader>W :w!<CR>

" Python
autocmd FileType python nmap <leader>b mm:%!black -q -<CR>`m

" snippets
autocmd FileType python imap <leader>re
\ raise NotImplementedError(f"Not implemented for {case=}")

autocmd FileType python imap <leader>ep
\ __import__("ptpython").repl.embed(globals(), locals())<ESC>

autocmd FileType python nmap <leader>ire :exec 'normal o<leader>re'<CR>?{<CR>lviw
autocmd FileType python nmap <leader>iep :exec 'normal o<leader>ep'<CR>
autocmd FileType python nmap <leader>id vip:Pydocstring<CR>
autocmd FileType python nmap <leader>b mm:%!black -q -<CR>`m

" YAML
autocmd FileType yaml nmap <leader>b 
\ mm:%s/ *$//<CR>:%s/\([:,]\)  */\1 /g<CR>:noh<CR>`m

nmap <silent> <leader>N <Plug>(ale_previous_wrap)
nmap <silent> <leader>n <Plug>(ale_next_wrap)

" Makefile
autocmd FileType Makefile nmap <leader>ilv dip:-1r!./get_last_vesions.sh

" Indent selection
vmap <leader>i :!gindent -npro -nut -nlp -bli4 -br -nprs -nsc -nss -pi4<CR>

" Quick insertion
nnoremap <leader>it :r!date +"\%A \%d \%B \%Y \%H:\%M:\%S"<CR>
nnoremap <leader>iT :-1r!date +"\%A \%d \%B \%Y \%H:\%M:\%S"<CR>
nnoremap <leader>id :r!date +"\%A \%d \%B \%Y"<CR>
nnoremap <leader>iD :-1r!date +"\%A \%d \%B \%Y"<CR>

nnoremap <leader>tt  :filetype detect<CR>
nnoremap <leader>ta :set filetype=awk<CR>
nnoremap <leader>tc :set filetype=c<CR>
nnoremap <leader>tj :set filetype=json<CR>
nnoremap <leader>tp :set filetype=python<CR>
nnoremap <leader>ts :set filetype=sh<CR>
nnoremap <leader>tv :set filetype=vim<CR>
nnoremap <leader>ty :set filetype=yaml<CR>
nnoremap <leader>th :set filetype=html<CR>
